<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXAGON - Firebase Real SDK</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK v9 -->
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.2/firebase-app-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.2/firebase-firestore-compat.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    
    <style>
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .product-card {
            transition: all 0.3s ease;
        }
        
        .product-card.selected {
            border-color: #2563eb;
            background-color: #f8fafc;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
        }
        
        .qty-controls {
            display: none;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        
        .qty-controls.show {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .completion-screen {
            display: none;
        }
        
        .completion-screen.show {
            display: block;
        }
        
        .main-content.hide {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- HEXAGON Title -->
    <div class="pt-8 pb-6 text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">üî• HEXAGON</h1>
        <h2 class="text-xl font-semibold text-gray-700 mb-2">Registro de Materiais Ortop√©dicos</h2>
        <div class="text-blue-600 font-medium">Firebase Real SDK ‚Ä¢ 11 Cole√ß√µes ‚Ä¢ 1.352 Produtos</div>
        <div id="connectionStatus" class="text-green-600 font-medium mt-2">
            <i class="fas fa-wifi mr-1"></i> Conectando ao Firebase...
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content max-w-6xl mx-auto px-4">
        
        <!-- Patient Information -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <h3 class="font-semibold mb-4 text-gray-800"><i class="fas fa-user mr-2"></i>Informa√ß√µes do Paciente</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Usu√°rio *</label>
                    <input type="text" id="userField" placeholder="Nome do usu√°rio" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Hospital *</label>
                    <input type="text" id="hospitalSelect" placeholder="Nome do hospital" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           oninput="capitalizeInput(this)">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Paciente</label>
                    <input type="text" id="patientName" placeholder="Nome do paciente" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           oninput="capitalizeInput(this)">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">N¬∞ Prontu√°rio</label>
                    <input type="text" id="recordNumber" placeholder="N√∫mero do prontu√°rio" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Data Cirurgia</label>
                    <input type="date" id="surgeryDate" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Outras Informa√ß√µes</label>
                    <textarea id="otherInfo" placeholder="Informa√ß√µes adicionais" rows="2" 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>
        </div>

        <!-- Product Selection -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <div class="mb-4">
                <label class="block font-medium text-gray-700 mb-2"><i class="fas fa-box mr-2"></i>Selecionar Subgrupo:</label>
                <select id="documentType" onchange="filterProducts()" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">üîÑ Carregando subgrupos...</option>
                </select>
            </div>

            <div id="productsContainer">
                <div class="text-center p-8 text-gray-600">
                    <i class="fas fa-hand-point-up text-4xl mb-4"></i>
                    <p>Selecione um subgrupo para visualizar os produtos</p>
                </div>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="showSelectedOnly()" 
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                <i class="fas fa-filter mr-2"></i>Filtrar Selecionados
            </button>
            <button onclick="showAllProducts()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                <i class="fas fa-eye mr-2"></i>Mostrar Todos
            </button>
        </div>

        <!-- Materiais Diversos -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <label class="block font-medium text-gray-700 mb-2"><i class="fas fa-plus mr-2"></i>Materiais Diversos:</label>
            <textarea id="materiaisDiversos" placeholder="Digite materiais diversos..." rows="4" 
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>

        <!-- Send Report Button -->
        <button onclick="sendReport()" 
                class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-xl mb-6 transition-colors">
            <i class="fas fa-paper-plane mr-2"></i>Enviar Relat√≥rio
        </button>
    </div>

    <!-- Completion Screen -->
    <div class="completion-screen">
        <div class="bg-white p-8 rounded-xl shadow-md mx-auto max-w-md text-center">
            <div class="text-6xl text-green-500 mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Relat√≥rio Enviado</h2>
            <p class="text-gray-600 mb-6">Relat√≥rio enviado com sucesso!</p>
            <button onclick="startNewReport()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg w-full transition-colors">
                <i class="fas fa-plus mr-2"></i>Novo Relat√≥rio
            </button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnJsxMxCLCcpqYCxrO4njbxKMTqoOpmtg",
            authDomain: "app-hexagon-materiais.firebaseapp.com",
            projectId: "app-hexagon-materiais",
            storageBucket: "app-hexagon-materiais.firebasestorage.app",
            messagingSenderId: "810793753497",
            appId: "1:810793753497:web:b5a6a812b18e09bfdd5108"
        };

        // Global variables
        let db;
        let currentProducts = [];
        let allSubgroups = new Map();
        
        // Collections
        const COLLECTIONS = [
            'parafusos_canulados', 'fixadores_externos', 'placas_sem_bloqueio_gr_frag',
            'placas_com_bloqueio_pequ_frag', 'hastes_intram_femur', 'hastes_intram_tibia',
            'hastes_intram_umero', 'micro_placas_com_bloqueio', 'placas_com_bloqueio_gr_frag',
            'placas_sem_bloqueio_pequ_frag', 'placas_volares_com_bloqueio'
        ];

        // Initialize Firebase
        function initializeFirebase() {
            try {
                console.log('üî• Inicializando Firebase...');
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-check-circle mr-1"></i> Conectado ao Firebase!';
                document.getElementById('connectionStatus').className = 'text-green-600 font-medium mt-2';
                
                console.log('‚úÖ Firebase inicializado com sucesso:', firebaseConfig.projectId);
                
                // Load subgroups after Firebase is initialized
                carregarSubgrupos();
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle mr-1"></i> Erro de conex√£o';
                document.getElementById('connectionStatus').className = 'text-red-600 font-medium mt-2';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Hexagon PWA iniciado');
            initializeFirebase();
        });
        
        // Capitalize input
        function capitalizeInput(input) {
            const words = input.value.toLowerCase().split(' ');
            input.value = words.map(word => 
                word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word
            ).join(' ');
        }
        
        // Load subgroups
        async function carregarSubgrupos() {
            try {
                const select = document.getElementById('documentType');
                select.innerHTML = '<option value="">üîÑ Carregando subgrupos...</option>';
                
                const gruposOrganizados = {};
                let totalSubgroups = 0;
                
                console.log('üì° Buscando subgrupos de todas as cole√ß√µes...');
                
                for (const collection of COLLECTIONS) {
                    try {
                        console.log(`üì° Buscando subgrupos de: ${collection}`);
                        
                        const snapshot = await db.collection(collection).orderBy('ordem_global').limit(500).get();
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.grupo && data.subgrupo) {
                                const grupo = data.grupo.trim();
                                const subgrupo = data.subgrupo.trim();
                                
                                if (!gruposOrganizados[grupo]) {
                                    gruposOrganizados[grupo] = new Set();
                                }
                                gruposOrganizados[grupo].add(subgrupo);
                                allSubgroups.set(subgrupo, collection);
                                totalSubgroups++;
                            }
                        });
                        
                        console.log(`‚úÖ ${collection}: ${snapshot.size} documentos processados`);
                        
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Erro na cole√ß√£o ${collection}:`, error);
                        if (error.message.includes('index')) {
                            console.log(`üí° Dica: Crie o √≠ndice para ${collection} no Firebase Console`);
                        }
                    }
                }
                
                // Build dropdown
                select.innerHTML = '<option value="">üìã Selecione um subgrupo</option>';
                
                Object.keys(gruposOrganizados).sort().forEach(grupo => {
                    const headerOption = document.createElement('option');
                    headerOption.value = '';
                    headerOption.textContent = `‚ïê‚ïê‚ïê ${grupo} ‚ïê‚ïê‚ïê`;
                    headerOption.disabled = true;
                    headerOption.style.fontWeight = 'bold';
                    headerOption.style.backgroundColor = '#374151';
                    headerOption.style.color = 'white';
                    select.appendChild(headerOption);
                    
                    Array.from(gruposOrganizados[grupo]).sort().forEach(subgrupo => {
                        const option = document.createElement('option');
                        option.value = subgrupo;
                        option.textContent = `  üì¶ ${subgrupo}`;
                        select.appendChild(option);
                    });
                });
                
                console.log(`‚úÖ Subgrupos carregados: ${allSubgroups.size} encontrados`);
                
                // Update connection status
                document.getElementById('connectionStatus').innerHTML = 
                    `<i class="fas fa-database mr-1"></i> ${allSubgroups.size} subgrupos carregados`;
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar subgrupos:', error);
                document.getElementById('documentType').innerHTML = '<option value="">‚ùå Erro ao carregar subgrupos</option>';
                
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle mr-1"></i> Erro ao carregar dados';
                document.getElementById('connectionStatus').className = 'text-red-600 font-medium mt-2';
            }
        }
        
        // Filter products
        async function filterProducts() {
            const subgrupo = document.getElementById('documentType').value;
            const container = document.getElementById('productsContainer');
            
            if (!subgrupo) {
                container.innerHTML = `
                    <div class="text-center p-8 text-gray-600">
                        <i class="fas fa-hand-point-up text-4xl mb-4"></i>
                        <p>Selecione um subgrupo para visualizar os produtos</p>
                    </div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="text-center p-8 text-blue-600">
                    <div class="loading-spinner"></div>
                    Buscando produtos do subgrupo: ${subgrupo}...
                </div>`;
            
            try {
                const collection = allSubgroups.get(subgrupo);
                if (!collection) {
                    container.innerHTML = `
                        <div class="text-center p-8 text-red-600">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>‚ùå Cole√ß√£o n√£o encontrada para este subgrupo</p>
                        </div>`;
                    return;
                }
                
                console.log(`üîç Buscando produtos de ${subgrupo} na cole√ß√£o ${collection}`);
                
                const snapshot = await db.collection(collection)
                    .where('subgrupo', '==', subgrupo)
                    .orderBy('ordem_global')
                    .limit(500)
                    .get();
                
                const produtos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    produtos.push({
                        codigo: data.codigo,
                        nome: data.descricao || data.nome,
                        ordem_global: data.ordem_global
                    });
                });
                
                currentProducts = produtos;
                renderProducts();
                
                console.log(`‚úÖ ${produtos.length} produtos encontrados para ${subgrupo}`);
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar produtos:', error);
                
                let errorMessage = 'Erro de conex√£o';
                if (error.message.includes('index')) {
                    errorMessage = '√çndice necess√°rio n√£o foi criado ainda';
                } else if (error.message.includes('permission')) {
                    errorMessage = 'Erro de permiss√£o';
                }
                
                container.innerHTML = `
                    <div class="text-center p-8 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>‚ùå ${errorMessage}</p>
                        <small class="text-gray-500 mt-2 block">
                            Verifique se os √≠ndices foram criados no Firebase Console
                        </small>
                    </div>`;
            }
        }
        
        // Render products
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            if (currentProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-8 text-gray-600">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p>üîç Nenhum produto encontrado neste subgrupo</p>
                    </div>`;
                return;
            }
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg';
            headerDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-blue-700 font-medium">
                        <i class="fas fa-box mr-2"></i>
                        ${currentProducts.length} produtos encontrados
                    </span>
                    <span class="text-blue-600 text-sm">
                        <i class="fas fa-sort-numeric-down mr-1"></i>
                        Ordenados por: Ordem Global
                    </span>
                </div>
            `;
            container.appendChild(headerDiv);
            
            currentProducts.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card bg-white border border-gray-300 rounded-lg p-4 mb-3';
                card.innerHTML = `
                    <div class="flex items-start gap-3">
                        <input type="checkbox" onchange="toggleProductSelection(${index})" 
                               class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                               id="checkbox-${index}">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${product.nome}</div>
                            <div class="text-gray-500 text-sm">
                                <i class="fas fa-barcode mr-1"></i>
                                C√≥digo: ${product.codigo}
                            </div>
                            <div class="text-blue-500 text-xs">
                                <i class="fas fa-sort-numeric-down mr-1"></i>
                                Ordem: ${product.ordem_global}
                            </div>
                        </div>
                    </div>
                    <div class="qty-controls" id="qty-controls-${index}">
                        <div class="flex items-center gap-2">
                            <label class="font-medium text-gray-700">Qtd:</label>
                            <select class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" style="width: 70px;">
                                <option value="">-</option>
                                ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="font-medium text-gray-700">Lote:</label>
                            <input type="text" placeholder="Lote" maxlength="15" 
                                   class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" style="width: 120px;">
                            <button onclick="addLot(${index})" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="additional-lots-${index}"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Toggle product selection
        function toggleProductSelection(index) {
            const checkbox = document.getElementById(`checkbox-${index}`);
            const controls = document.getElementById(`qty-controls-${index}`);
            const card = checkbox.closest('.product-card');
            
            if (checkbox.checked) {
                controls.classList.add('show');
                card.classList.add('selected');
            } else {
                controls.classList.remove('show');
                card.classList.remove('selected');
                document.getElementById(`additional-lots-${index}`).innerHTML = '';
            }
        }
        
        // Add lot
        function addLot(productIndex) {
            const container = document.getElementById(`additional-lots-${productIndex}`);
            const lotDiv = document.createElement('div');
            lotDiv.className = 'flex items-center gap-2 mt-2 p-2 bg-gray-100 rounded-md';
            lotDiv.innerHTML = `
                <label class="font-medium text-gray-700">Qtd:</label>
                <select class="p-1 border border-gray-300 rounded-md" style="width: 60px;">
                    <option value="">-</option>
                    ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                </select>
                <label class="font-medium text-gray-700">Lote:</label>
                <input type="text" placeholder="Lote" maxlength="15" 
                       class="p-1 border border-gray-300 rounded-md" style="width: 100px;">
                <button onclick="removeLot(this)" 
                        class="bg-red-600 hover:bg-red-700 text-white p-1 rounded-md transition-colors">
                    <i class="fas fa-minus"></i>
                </button>
            `;
            container.appendChild(lotDiv);
        }
        
        // Remove lot
        function removeLot(button) {
            button.closest('div').remove();
        }
        
        // Show selected only
        function showSelectedOnly() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (!checkbox.checked) {
                    card.style.display = 'none';
                }
            });
        }
        
        // Show all products
        function showAllProducts() {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                card.style.display = 'block';
            });
        }
        
        // Format date
        function formatDateBrazilian(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        
        // Generate PDF
        function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('HEXAGON - FIREBASE REAL SDK', 105, 20, { align: 'center' });
                
                let yPos = 40;
                doc.setFontSize(12);
                doc.text('REGISTRO DE CONSUMO DE MATERIAIS', 105, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(10);
                doc.text(`Usuario: ${document.getElementById('userField').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Hospital: ${document.getElementById('hospitalSelect').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Paciente: ${document.getElementById('patientName').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Prontuario: ${document.getElementById('recordNumber').value || ''}`, 20, yPos);
                yPos += 7;
                doc.text(`Data: ${formatDateBrazilian(document.getElementById('surgeryDate').value)}`, 20, yPos);
                yPos += 15;
                
                // Materials
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    const index = parseInt(checkbox.id.split('-')[1]);
                    const product = currentProducts[index];
                    
                    const qtyControls = document.getElementById(`qty-controls-${index}`);
                    const qtySelect = qtyControls.querySelector('select');
                    const lotInput = qtyControls.querySelector('input[type="text"]');
                    
                    if (lotInput.value) {
                        doc.text(`Codigo: ${product.codigo}`, 20, yPos);
                        yPos += 5;
                        doc.text(`Produto: ${product.nome}`, 20, yPos);
                        yPos += 5;
                        doc.text(`Lote: ${lotInput.value} | Qtd: ${qtySelect.value || '1'}`, 20, yPos);
                        yPos += 10;
                        
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 20;
                        }
                    }
                });
                
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    yPos += 5;
                    doc.text('Materiais Diversos:', 20, yPos);
                    yPos += 5;
                    const lines = doc.splitTextToSize(diversos, 170);
                    lines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 5;
                    });
                }
                
                return doc;
                
            } catch (error) {
                console.error('Erro PDF:', error);
                throw error;
            }
        }

        // Send report
        function sendReport() {
            try {
                const userField = document.getElementById('userField').value.trim();
                const hospitalSelect = document.getElementById('hospitalSelect').value.trim();
                
                if (!userField) {
                    alert('‚ö†Ô∏è Preencha o campo Usu√°rio');
                    return;
                }
                
                if (!hospitalSelect) {
                    alert('‚ö†Ô∏è Preencha o campo Hospital');
                    return;
                }
                
                let message = 'üè• REGISTRO DE CONSUMO - HEXAGON FIREBASE REAL\n';
                message += '===============================\n\n';
                message += `üë§ Usuario: ${userField}\n`;
                message += `üè• Hospital: ${hospitalSelect}\n`;
                message += `ü§ï Paciente: ${document.getElementById('patientName').value || 'N/A'}\n`;
                message += `üìã Prontuario: ${document.getElementById('recordNumber').value || 'N/A'}\n`;
                message += `üìÖ Data: ${formatDateBrazilian(document.getElementById('surgeryDate').value) || 'N/A'}\n`;
                message += `üìù Outras Info: ${document.getElementById('otherInfo').value || 'Nenhuma'}\n`;
                message += '===============================\n\n';
                
                // Materials
                const checkboxes = document.querySelectorAll('.product-card input[type="checkbox"]:checked');
                let materialCount = 0;
                
                if (checkboxes.length > 0) {
                    message += 'üì¶ MATERIAIS UTILIZADOS:\n';
                    
                    checkboxes.forEach(checkbox => {
                        const index = parseInt(checkbox.id.split('-')[1]);
                        const product = currentProducts[index];
                        
                        const qtyControls = document.getElementById(`qty-controls-${index}`);
                        const qtySelect = qtyControls.querySelector('select');
                        const lotInput = qtyControls.querySelector('input[type="text"]');
                        
                        if (lotInput.value) {
                            materialCount++;
                            message += `\n${materialCount}. üì¶ ${product.codigo}\n`;
                            message += `   üìã ${product.nome}\n`;
                            message += `   üè∑Ô∏è Lote: ${lotInput.value}\n`;
                            message += `   üî¢ Qtd: ${qtySelect.value || '1'}\n`;
                        }
                    });
                } else {
                    message += '‚ö†Ô∏è NENHUM MATERIAL SELECIONADO\n';
                }
                
                const diversos = document.getElementById('materiaisDiversos').value;
                if (diversos) {
                    message += '\n===============================\n';
                    message += '‚ûï MATERIAIS DIVERSOS:\n';
                    message += diversos + '\n';
                }
                
                // Generate PDF
                try {
                    const pdf = generatePDF();
                    const pdfBlob = pdf.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.download = `Hexagon_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    message += '\nüìÑ PDF salvo no dispositivo';
                    
                } catch (pdfError) {
                    console.error('Erro PDF:', pdfError);
                    message += '\n‚ö†Ô∏è Erro ao gerar PDF';
                }
                
                message += `\n\n‚è∞ ${new Date().toLocaleString('pt-BR')}`;
                message += '\nüî• Hexagon Firebase Real SDK v4.0';
                
                // WhatsApp
                const whatsappUrl = `https://wa.me/5519998935452?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                showCompletionScreen();
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                alert('‚ùå Erro ao enviar relat√≥rio');
            }
        }

        // Show completion screen
        function showCompletionScreen() {
            document.querySelector('.main-content').classList.add('hide');
            document.querySelector('.completion-screen').classList.add('show');
        }

        // Start new report
        function startNewReport() {
            document.getElementById('otherInfo').value = '';
            document.getElementById('materiaisDiversos').value = '';
            document.getElementById('documentType').value = '';
            document.getElementById('productsContainer').innerHTML = `
                <div class="text-center p-8 text-gray-600">
                    <i class="fas fa-hand-point-up text-4xl mb-4"></i>
                    <p>Selecione um subgrupo para visualizar os produtos</p>
                </div>`;
            
            document.querySelector('.main-content').classList.remove('hide');
            document.querySelector('.completion-screen').classList.remove('show');
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"963e70d9898c13ca","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.7.0","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDoNVhr17WVc0MEm5R7KpiusN7JIP%2FBFDgoMmnz8pT%2FlQhbdnbz7szUCg1FpGa2wFBYffh%2BHWSoljeG6zYhYpWYIG09mBd6tyuJ8ENmLwdOZRzaiybSWkw5N%2FyhxXqAgDS2O7mpe1C8d4ACECM0H5sQpH8LadRAfBGDjRMnHfCpieEvfOmPBPusdcB7CH%2FWgrqpvdKr5gI77nsc5nFI1XjP6b7O%2FvoYf8M1py9eeMQTl4O%2FF9GWYdwIgGCq3NMLDK%2BgPJ6ILB%2BBXCHPoARHI%2Bm%2B2fptl2Yc0y2fIqiTImvVnUTUVb9Dc9NbkeH6u3vQMLXYCF3aloenrEHRmcdFKjlQitEjiQ7NEdPRg17UQpRLIvX0xhCffHPTERwACmdAKed32ENsr9N%2B0ePkzyfqVQ5u7iw0oPdbZW1c%2FZDRtslhnL0DaS7swuKrQaCV4XYKMdw4VNOg66b%2B5h40cakgtsNY0mg3wMmRaXhHvSGldZJ8OWRhi0kfiZJKRXp2JL0C8PhZvYMcg2Gmso3L%2BkwNAZb5I%3D";
        window.__genspark_locale = "pt-BR";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDoNVhr17WVc0MEm5R7KpiusN7JIP/BFDgoMmnz8pT/lQhbdnbz7szUCg1FpGa2wFBYffh+HWSoljeG6zYhYpWYIG09mBd6tyuJ8ENmLwdOZRzaiybSWkw5N/yhxXqAgDS2O7mpe1C8d4ACECM0H5sQpH8LadRAfBGDjRMnHfCpieEvfOmPBPusdcB7CH/WgrqpvdKr5gI77nsc5nFI1XjP6b7O/voYf8M1py9eeMQTl4O/F9GWYdwIgGCq3NMLDK+gPJ6ILB+BXCHPoARHI+m+2fptl2Yc0y2fIqiTImvVnUTUVb9Dc9NbkeH6u3vQMLXYCF3aloenrEHRmcdFKjlQitEjiQ7NEdPRg17UQpRLIvX0xhCffHPTERwACmdAKed32ENsr9N+0ePkzyfqVQ5u7iw0oPdbZW1c/ZDRtslhnL0DaS7swuKrQaCV4XYKMdw4VNOg66b+5h40cakgtsNY0mg3wMmRaXhHvSGldZJ8OWRhi0kfiZJKRXp2JL0C8PhZvYMcg2Gmso3L+kwNAZb5I=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
